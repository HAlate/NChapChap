# ğŸ”„ Workflows Complets - SystÃ¨me de NÃ©gociation

**Date**: 2025-11-30
**Source**: NEGOTIATION_CONTEXTE_AFRICAIN.md
**Contexte**: SystÃ¨me adaptÃ© Ã  la rÃ©alitÃ© africaine

---

## ğŸ“‹ Table des MatiÃ¨res

1. [Workflow 1: Trajet Standard (Rider â†’ Driver)](#workflow-1-trajet-standard)
2. [Workflow 2: Livraison Marchandise](#workflow-2-livraison-marchandise)
3. [Workflow 3: Livraison Restaurant](#workflow-3-livraison-restaurant)
4. [Ã‰tats et Transitions](#Ã©tats-et-transitions)
5. [Diagrammes de SÃ©quence](#diagrammes-de-sÃ©quence)

---

## Workflow 1: Trajet Standard (Rider â†’ Driver)

### Phase 1: CrÃ©ation de Demande (Rider)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰CRAN: TripScreen (mobile_rider)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Rider ouvre l'app                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. SÃ©lectionne:                                             â”‚
â”‚    â€¢ DÃ©part: "LomÃ© Centre"                                  â”‚
â”‚    â€¢ Destination: "AÃ©roport GnassingbÃ© EyadÃ©ma"             â”‚
â”‚    â€¢ Type vÃ©hicule: "moto-taxi"                             â”‚
â”‚    â€¢ Commander pour: "Moi-mÃªme"                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Clique "Rechercher des chauffeurs"                       â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Message affichÃ©:                                         â”‚
â”‚    ğŸ’¡ "Les chauffeurs disponibles vous proposeront          â”‚
â”‚        leurs prix. Vous pourrez comparer et choisir."       â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. POST /api/trips                                          â”‚
â”‚    {                                                        â”‚
â”‚      "rider_id": "uuid",                                    â”‚
â”‚      "departure": "LomÃ© Centre",                            â”‚
â”‚      "departure_lat": 6.1319,                               â”‚
â”‚      "departure_lng": 1.2228,                               â”‚
â”‚      "destination": "AÃ©roport GnassingbÃ© EyadÃ©ma",          â”‚
â”‚      "destination_lat": 6.1656,                             â”‚
â”‚      "destination_lng": 1.2546,                             â”‚
â”‚      "vehicle_type": "moto-taxi",                           â”‚
â”‚      "status": "pending"                                    â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. RÃ©ponse:                                                 â”‚
â”‚    {                                                        â”‚
â”‚      "id": "trip-uuid-123",                                 â”‚
â”‚      "status": "pending",                                   â”‚
â”‚      "created_at": "2025-11-30T10:30:00Z"                   â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 7. Navigation automatique â†’ WaitingOffersScreen            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Base de donnÃ©es:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: trips                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: trip-uuid-123                                           â”‚
â”‚ rider_id: rider-uuid                                        â”‚
â”‚ driver_id: NULL                                             â”‚
â”‚ departure: "LomÃ© Centre"                                    â”‚
â”‚ destination: "AÃ©roport GnassingbÃ© EyadÃ©ma"                  â”‚
â”‚ vehicle_type: "moto-taxi"                                   â”‚
â”‚ status: "pending"                                           â”‚
â”‚ created_at: 2025-11-30T10:30:00Z                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Notification Drivers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: Notification System                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Trigger aprÃ¨s crÃ©ation trip:                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Recherche drivers disponibles:                           â”‚
â”‚    SELECT * FROM users                                      â”‚
â”‚    WHERE user_type = 'driver'                               â”‚
â”‚      AND is_online = true                                   â”‚
â”‚      AND vehicle_type = 'moto-taxi'                         â”‚
â”‚      AND EXISTS (                                           â”‚
â”‚        SELECT 1 FROM token_balances                         â”‚
â”‚        WHERE user_id = users.id                             â”‚
â”‚          AND token_type = 'course'                          â”‚
â”‚          AND balance >= 1                                   â”‚
â”‚      )                                                      â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. RÃ©sultat: 8 drivers trouvÃ©s                              â”‚
â”‚    â€¢ Driver A (Kofi): 5 jetons                              â”‚
â”‚    â€¢ Driver B (Ama): 3 jetons                               â”‚
â”‚    â€¢ Driver C (Kwame): 2 jetons                             â”‚
â”‚    â€¢ ... (5 autres)                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Push notification Ã  chaque driver:                       â”‚
â”‚    {                                                        â”‚
â”‚      "title": "Nouvelle demande",                           â”‚
â”‚      "body": "LomÃ© Centre â†’ AÃ©roport (moto-taxi)",          â”‚
â”‚      "data": {                                              â”‚
â”‚        "trip_id": "trip-uuid-123",                          â”‚
â”‚        "type": "new_trip_request"                           â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Drivers Voient Demande

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰CRAN: DriverRequestsScreen (mobile_driver)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Driver reÃ§oit notification push                          â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Ouvre l'app â†’ DriverRequestsScreen                       â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. GET /api/trips?status=pending&vehicle_type=moto-taxi     â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Voit la liste des demandes:                              â”‚
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ Demandes          ğŸª™ 5 jetons    â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ‘¤ Kofi Mensah â€¢ â­ 4.8          â”‚                   â”‚
â”‚    â”‚ â±ï¸ Il y a 2min    [moto-taxi]   â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸŸ¢ LomÃ© Centre                   â”‚                   â”‚
â”‚    â”‚  |                                â”‚                   â”‚
â”‚    â”‚ ğŸ”´ AÃ©roport GnassingbÃ©           â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ“ 8.5 km   [Faire une offre]   â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 4: Driver Fait une Proposition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODAL: Faire une offre (mobile_driver)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Driver A (Kofi) clique "Faire une offre"                 â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Modal s'ouvre avec:                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ Faire une offre                   â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ â„¹ï¸ VÃ©rification: Jeton requis     â”‚                   â”‚
â”‚    â”‚    (5 disponibles)                â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸª™ Jeton dÃ©pensÃ© SEULEMENT        â”‚                   â”‚
â”‚    â”‚    si accord final                â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Trajet:                           â”‚                   â”‚
â”‚    â”‚ LomÃ© Centre â†’ AÃ©roport            â”‚                   â”‚
â”‚    â”‚ Distance: 8.5 km                  â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Prix (FCFA): [1500]               â”‚                   â”‚
â”‚    â”‚ ETA (min): [5]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ [Envoyer la proposition]          â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Driver entre:                                            â”‚
â”‚    â€¢ Prix: 1500 FCFA                                        â”‚
â”‚    â€¢ ETA: 5 minutes                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Clique "Envoyer la proposition"                          â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. Validation front-end:                                    â”‚
â”‚    âœ… Prix > 0                                              â”‚
â”‚    âœ… Jetons >= 1                                           â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. POST /api/trip-offers                                    â”‚
â”‚    {                                                        â”‚
â”‚      "trip_id": "trip-uuid-123",                            â”‚
â”‚      "driver_id": "driver-a-uuid",                          â”‚
â”‚      "offered_price": 1500,                                 â”‚
â”‚      "eta_minutes": 5,                                      â”‚
â”‚      "vehicle_type": "moto-taxi"                            â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 7. Backend vÃ©rifie:                                         â”‚
â”‚    âœ… Driver a >= 1 jeton (RLS policy)                      â”‚
â”‚    âœ… Trip existe et status = 'pending'                     â”‚
â”‚    â†“                                                        â”‚
â”‚ 8. RÃ©ponse:                                                 â”‚
â”‚    {                                                        â”‚
â”‚      "id": "offer-uuid-a",                                  â”‚
â”‚      "status": "pending",                                   â”‚
â”‚      "token_spent": false,                                  â”‚
â”‚      "message": "Proposition envoyÃ©e"                       â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 9. Notification de succÃ¨s:                                  â”‚
â”‚    âœ“ Proposition envoyÃ©e!                                   â”‚
â”‚    1500 FCFA â€¢ ArrivÃ©e: 5min                                â”‚
â”‚    Jeton dÃ©pensÃ© si acceptÃ©e                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Base de donnÃ©es:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: trip_offers                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: offer-uuid-a                                            â”‚
â”‚ trip_id: trip-uuid-123                                      â”‚
â”‚ driver_id: driver-a-uuid (Kofi)                             â”‚
â”‚ offered_price: 1500                                         â”‚
â”‚ counter_price: NULL                                         â”‚
â”‚ final_price: NULL                                           â”‚
â”‚ eta_minutes: 5                                              â”‚
â”‚ status: "pending"                                           â”‚
â”‚ token_spent: false                                          â”‚
â”‚ created_at: 2025-11-30T10:32:00Z                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 5: Autres Drivers Font Leurs Propositions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Propositions Multiples (2-5 minutes aprÃ¨s demande)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Driver B (Ama):                                             â”‚
â”‚ â€¢ Prix: 1200 FCFA                                           â”‚
â”‚ â€¢ ETA: 8 minutes                                            â”‚
â”‚ â€¢ Status: pending                                           â”‚
â”‚ â€¢ Jeton: vÃ©rifiÃ© (3 disponibles), pas dÃ©pensÃ©              â”‚
â”‚                                                             â”‚
â”‚ Driver C (Kwame):                                           â”‚
â”‚ â€¢ Prix: 1800 FCFA                                           â”‚
â”‚ â€¢ ETA: 3 minutes                                            â”‚
â”‚ â€¢ Status: pending                                           â”‚
â”‚ â€¢ Jeton: vÃ©rifiÃ© (2 disponibles), pas dÃ©pensÃ©              â”‚
â”‚                                                             â”‚
â”‚ Driver D (Edem):                                            â”‚
â”‚ â€¢ Prix: 1600 FCFA                                           â”‚
â”‚ â€¢ ETA: 6 minutes                                            â”‚
â”‚ â€¢ Status: pending                                           â”‚
â”‚ â€¢ Jeton: vÃ©rifiÃ© (4 disponibles), pas dÃ©pensÃ©              â”‚
â”‚                                                             â”‚
â”‚ Driver E (Yao):                                             â”‚
â”‚ â€¢ Prix: 1400 FCFA                                           â”‚
â”‚ â€¢ ETA: 7 minutes                                            â”‚
â”‚ â€¢ Status: pending                                           â”‚
â”‚ â€¢ Jeton: vÃ©rifiÃ© (1 disponible), pas dÃ©pensÃ©               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Base de donnÃ©es:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: trip_offers (5 entrÃ©es pour trip-uuid-123)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ offer-uuid-a | driver-a (Kofi)  | 1500 | 5min | pending   â”‚
â”‚ offer-uuid-b | driver-b (Ama)   | 1200 | 8min | pending   â”‚
â”‚ offer-uuid-c | driver-c (Kwame) | 1800 | 3min | pending   â”‚
â”‚ offer-uuid-d | driver-d (Edem)  | 1600 | 6min | pending   â”‚
â”‚ offer-uuid-e | driver-e (Yao)   | 1400 | 7min | pending   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 6: Rider Voit les Propositions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰CRAN: WaitingOffersScreen (mobile_rider)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Polling ou Realtime:                                     â”‚
â”‚    GET /api/trip-offers?trip_id=trip-uuid-123               â”‚
â”‚    Ou: Supabase Realtime subscription                       â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Rider voit les offres arriver en temps rÃ©el:             â”‚
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ 5 chauffeurs disponibles          â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ‘¤ Ama    ğŸ’° 1200 F  â±ï¸ 8min    â”‚                   â”‚
â”‚    â”‚ â­ 4.8 â€¢ 234 courses             â”‚                   â”‚
â”‚    â”‚ [SÃ©lectionner]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ‘¤ Yao    ğŸ’° 1400 F  â±ï¸ 7min    â”‚                   â”‚
â”‚    â”‚ â­ 4.7 â€¢ 189 courses             â”‚                   â”‚
â”‚    â”‚ [SÃ©lectionner]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ‘¤ Kofi   ğŸ’° 1500 F  â±ï¸ 5min    â”‚                   â”‚
â”‚    â”‚ â­ 4.9 â€¢ 456 courses             â”‚                   â”‚
â”‚    â”‚ [SÃ©lectionner]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ‘¤ Edem   ğŸ’° 1600 F  â±ï¸ 6min    â”‚                   â”‚
â”‚    â”‚ â­ 4.6 â€¢ 123 courses             â”‚                   â”‚
â”‚    â”‚ [SÃ©lectionner]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ‘¤ Kwame  ğŸ’° 1800 F  â±ï¸ 3min    â”‚                   â”‚
â”‚    â”‚ â­ 4.7 â€¢ 298 courses             â”‚                   â”‚
â”‚    â”‚ [SÃ©lectionner]                    â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â”‚ 3. Rider analyse:                                           â”‚
â”‚    â€¢ Prix le plus bas: Ama (1200 F)                         â”‚
â”‚    â€¢ Meilleure note: Kofi (4.9)                             â”‚
â”‚    â€¢ Plus rapide: Kwame (3 min)                             â”‚
â”‚    â€¢ Bon compromis: Yao (1400 F, 7 min)                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 7A: Rider Accepte Directement (Sans NÃ©gociation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCÃ‰NARIO A: Acceptation Directe                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Rider dÃ©cide d'accepter Ama (1200 F, meilleur prix)      â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Clique "SÃ©lectionner" sur la carte d'Ama                 â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Modal de confirmation:                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ Confirmer le chauffeur?           â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ‘¤ Ama                            â”‚                   â”‚
â”‚    â”‚ â­ 4.8 â€¢ 234 courses             â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ ğŸ’° Prix: 1200 FCFA                â”‚                   â”‚
â”‚    â”‚ â±ï¸ ArrivÃ©e: 8 minutes            â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ [âœ“ Accepter 1200 F]               â”‚                   â”‚
â”‚    â”‚ [â†” Contre-proposer]               â”‚                   â”‚
â”‚    â”‚ [âœ— Annuler]                       â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Rider clique "Accepter 1200 F"                           â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. PATCH /api/trip-offers/offer-uuid-b/accept               â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. Backend:                                                 â”‚
â”‚    a) Update trip_offers:                                   â”‚
â”‚       offer-uuid-b: status = 'accepted'                     â”‚
â”‚       offer-uuid-b: final_price = 1200                      â”‚
â”‚       offer-uuid-b: token_spent = true âœ…                   â”‚
â”‚       Autres offres: status = 'not_selected'                â”‚
â”‚                                                             â”‚
â”‚    b) Update trips:                                         â”‚
â”‚       trip-uuid-123: status = 'accepted'                    â”‚
â”‚       trip-uuid-123: driver_id = driver-b-uuid (Ama)        â”‚
â”‚       trip-uuid-123: final_price = 1200                     â”‚
â”‚       trip-uuid-123: accepted_at = NOW()                    â”‚
â”‚                                                             â”‚
â”‚    c) âœ… DÃ‰DUCTION JETON (via trigger):                     â”‚
â”‚       UPDATE token_balances                                 â”‚
â”‚       SET balance = balance - 1                             â”‚
â”‚       WHERE user_id = driver-b-uuid                         â”‚
â”‚         AND token_type = 'course'                           â”‚
â”‚                                                             â”‚
â”‚       token_balances (Ama):                                 â”‚
â”‚       Before: 3 jetons                                      â”‚
â”‚       After:  2 jetons âœ…                                   â”‚
â”‚                                                             â”‚
â”‚    d) INSERT token_transactions:                            â”‚
â”‚       {                                                     â”‚
â”‚         user_id: driver-b-uuid,                             â”‚
â”‚         token_type: 'course',                               â”‚
â”‚         amount: -1,                                         â”‚
â”‚         reason: 'trip_accepted',                            â”‚
â”‚         related_id: trip-uuid-123                           â”‚
â”‚       }                                                     â”‚
â”‚                                                             â”‚
â”‚    e) Notifications:                                        â”‚
â”‚       â†’ Ama: "Course acceptÃ©e! 1200 FCFA"                   â”‚
â”‚       â†’ Autres drivers: "Course attribuÃ©e Ã  un autre"       â”‚
â”‚    â†“                                                        â”‚
â”‚ 7. Navigation:                                              â”‚
â”‚    â€¢ Rider â†’ TrackingScreen (suivi en temps rÃ©el)           â”‚
â”‚    â€¢ Driver Ama â†’ AcceptedTripScreen (navigation)           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Base de donnÃ©es finale:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: trips                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: trip-uuid-123                                           â”‚
â”‚ status: "accepted" âœ…                                       â”‚
â”‚ driver_id: driver-b-uuid (Ama) âœ…                           â”‚
â”‚ final_price: 1200 âœ…                                        â”‚
â”‚ accepted_at: 2025-11-30T10:35:00Z âœ…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: trip_offers                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ offer-uuid-b | status: "accepted" | token_spent: true âœ…   â”‚
â”‚ offer-uuid-a | status: "not_selected" | token_spent: false â”‚
â”‚ offer-uuid-c | status: "not_selected" | token_spent: false â”‚
â”‚ offer-uuid-d | status: "not_selected" | token_spent: false â”‚
â”‚ offer-uuid-e | status: "not_selected" | token_spent: false â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: token_balances                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ driver-b-uuid (Ama): balance = 2 (Ã©tait 3) âœ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 7B: Rider NÃ©gocie (Contre-Proposition)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCÃ‰NARIO B: NÃ©gociation                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Rider sÃ©lectionne Kofi (1500 F, meilleure note 4.9)      â”‚
â”‚    Mais trouve le prix un peu Ã©levÃ©                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Clique "SÃ©lectionner" sur la carte de Kofi               â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Modal de confirmation s'ouvre                            â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Rider clique "â†” Contre-proposer"                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. Ã‰CRAN: NegotiationScreen                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ NÃ©gociation avec Kofi             â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ‘¤ Kofi Mensah                    â”‚                   â”‚
â”‚    â”‚ â­ 4.9 â€¢ 456 courses             â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Prix proposÃ©: 1500 FCFA           â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Votre contre-offre:               â”‚                   â”‚
â”‚    â”‚ [1300] FCFA                       â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Message (optionnel):              â”‚                   â”‚
â”‚    â”‚ "C'est un peu Ã©levÃ© pour moi,     â”‚                   â”‚
â”‚    â”‚  pouvez-vous accepter 1300?"      â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ [Envoyer contre-offre]            â”‚                   â”‚
â”‚    â”‚ [âœ“ Accepter 1500 F]               â”‚                   â”‚
â”‚    â”‚ [âœ— Choisir un autre chauffeur]   â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. Rider entre 1300 F et envoie                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 7. PATCH /api/trip-offers/offer-uuid-a                      â”‚
â”‚    {                                                        â”‚
â”‚      "status": "selected",                                  â”‚
â”‚      "counter_price": 1300,                                 â”‚
â”‚      "message": "C'est un peu Ã©levÃ©..."                     â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 8. Backend:                                                 â”‚
â”‚    â€¢ Update offer-uuid-a:                                   â”‚
â”‚      status = 'selected'                                    â”‚
â”‚      counter_price = 1300                                   â”‚
â”‚    â€¢ Update autres offres:                                  â”‚
â”‚      status = 'not_selected'                                â”‚
â”‚    â€¢ Push notification Ã  Kofi                               â”‚
â”‚    â†“                                                        â”‚
â”‚ 9. Rider voit message:                                      â”‚
â”‚    "â³ Contre-offre envoyÃ©e Ã  Kofi.                         â”‚
â”‚        En attente de sa rÃ©ponse..."                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Driver Kofi reÃ§oit notification                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Push notification:                                       â”‚
â”‚    "ğŸ’° Contre-offre reÃ§ue: 1300 FCFA (au lieu 1500)"        â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Kofi ouvre l'app â†’ NegotiationDriverScreen               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ Contre-offre reÃ§ue                â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ‘¤ Client: Mensah                 â”‚                   â”‚
â”‚    â”‚ â­ 4.8                            â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Trajet:                           â”‚                   â”‚
â”‚    â”‚ LomÃ© Centre â†’ AÃ©roport            â”‚                   â”‚
â”‚    â”‚ Distance: 8.5 km                  â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Votre prix: 1500 FCFA             â”‚                   â”‚
â”‚    â”‚ Contre-offre: 1300 FCFA           â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ Message du client:                â”‚                   â”‚
â”‚    â”‚ "C'est un peu Ã©levÃ© pour moi..."  â”‚                   â”‚
â”‚    â”‚                                   â”‚                   â”‚
â”‚    â”‚ [âœ“ Accepter 1300 F]               â”‚                   â”‚
â”‚    â”‚ [â†” Contre-proposer]               â”‚                   â”‚
â”‚    â”‚ [âœ— Refuser]                       â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Kofi analyse:                                            â”‚
â”‚    â€¢ 1500 - 1300 = 200 F de diffÃ©rence                      â”‚
â”‚    â€¢ Client a bonne note (4.8)                              â”‚
â”‚    â€¢ Trajet rentable mÃªme Ã  1300                            â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. OPTION A: Kofi accepte 1300 F                            â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. Clique "âœ“ Accepter 1300 F"                               â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. PATCH /api/trip-offers/offer-uuid-a/accept               â”‚
â”‚    {                                                        â”‚
â”‚      "final_price": 1300                                    â”‚
â”‚    }                                                        â”‚
â”‚    â†“                                                        â”‚
â”‚ 7. Backend:                                                 â”‚
â”‚    a) Update trip_offers:                                   â”‚
â”‚       offer-uuid-a: status = 'accepted'                     â”‚
â”‚       offer-uuid-a: final_price = 1300 âœ…                   â”‚
â”‚       offer-uuid-a: token_spent = true âœ…                   â”‚
â”‚                                                             â”‚
â”‚    b) Update trips:                                         â”‚
â”‚       trip-uuid-123: status = 'accepted'                    â”‚
â”‚       trip-uuid-123: driver_id = driver-a-uuid (Kofi)       â”‚
â”‚       trip-uuid-123: final_price = 1300 âœ…                  â”‚
â”‚       trip-uuid-123: accepted_at = NOW()                    â”‚
â”‚                                                             â”‚
â”‚    c) âœ… DÃ‰DUCTION JETON (via trigger):                     â”‚
â”‚       Kofi: 5 jetons â†’ 4 jetons âœ…                          â”‚
â”‚                                                             â”‚
â”‚    d) Notifications:                                        â”‚
â”‚       â†’ Rider: "Kofi a acceptÃ© 1300 FCFA!"                  â”‚
â”‚       â†’ Kofi: "Course confirmÃ©e! 1300 FCFA"                 â”‚
â”‚    â†“                                                        â”‚
â”‚ 8. Course dÃ©marre                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPTION B: Kofi refuse la contre-offre                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Kofi clique "âœ— Refuser"                                  â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. PATCH /api/trip-offers/offer-uuid-a/reject               â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Backend:                                                 â”‚
â”‚    â€¢ offer-uuid-a: status = 'rejected'                      â”‚
â”‚    â€¢ offer-uuid-a: token_spent = false âœ… (jeton intact)    â”‚
â”‚    â€¢ Notification rider: "Kofi a refusÃ© votre contre-offre" â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Rider retourne Ã  la liste des offres                     â”‚
â”‚    Peut choisir un autre driver (ex: Ama Ã  1200 F)          â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. Kofi: jeton toujours 5 âœ… (pas dÃ©pensÃ© car pas d'accord) â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 8: Course en Cours

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰CRAN: TrackingScreen (mobile_rider)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Course acceptÃ©e â†’ Status: "accepted"                     â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. Driver dÃ©marre trajet â†’ PATCH /api/trips/:id/start       â”‚
â”‚    â€¢ Status: "accepted" â†’ "started"                         â”‚
â”‚    â€¢ started_at: NOW()                                      â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. Rider suit en temps rÃ©el:                                â”‚
â”‚    â€¢ Position driver sur carte                              â”‚
â”‚    â€¢ Distance restante                                      â”‚
â”‚    â€¢ ETA mis Ã  jour                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Driver arrive â†’ PATCH /api/trips/:id/complete            â”‚
â”‚    â€¢ Status: "started" â†’ "completed"                        â”‚
â”‚    â€¢ completed_at: NOW()                                    â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. Ã‰cran d'Ã©valuation mutuelle                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tats du trip:
â€¢ pending â†’ accepted â†’ started â†’ completed âœ…
â€¢ Jeton dÃ©pensÃ© au moment de "accepted" âœ…
```

---

## Workflow 2: Livraison Marchandise (Merchant â†’ Driver)

### DiffÃ©rences avec Trajet Standard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPÃ‰CIFICITÃ‰S LIVRAISON MARCHANDISE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Demande crÃ©Ã©e par Merchant (pas Rider)                   â”‚
â”‚    â€¢ Table: delivery_requests (pas trips)                   â”‚
â”‚    â€¢ merchant_id au lieu de rider_id                        â”‚
â”‚    â€¢ Champs supplÃ©mentaires:                                â”‚
â”‚      - package_description                                  â”‚
â”‚      - package_weight                                       â”‚
â”‚      - recipient_name                                       â”‚
â”‚      - recipient_phone                                      â”‚
â”‚      - delivery_notes                                       â”‚
â”‚                                                             â”‚
â”‚ 2. Drivers voient dans DriverDeliveryRequestsScreen         â”‚
â”‚    â€¢ Affiche infos colis                                    â”‚
â”‚    â€¢ MÃªme logique de propositions                           â”‚
â”‚    â€¢ Jeton vÃ©rifiÃ© mais pas dÃ©pensÃ©                         â”‚
â”‚                                                             â”‚
â”‚ 3. Merchant voit propositions                               â”‚
â”‚    â€¢ MÃªme logique de sÃ©lection/nÃ©gociation                  â”‚
â”‚    â€¢ Acceptation â†’ DÃ©pense jeton driver âœ…                  â”‚
â”‚                                                             â”‚
â”‚ 4. Livraison en cours                                       â”‚
â”‚    â€¢ Driver rÃ©cupÃ¨re colis chez merchant                    â”‚
â”‚    â€¢ Livre au destinataire                                  â”‚
â”‚    â€¢ Confirmation de livraison (photo/signature)            â”‚
â”‚                                                             â”‚
â”‚ 5. Paiement                                                 â”‚
â”‚    â€¢ Merchant paie driver                                   â”‚
â”‚    â€¢ Ã‰valuation mutuelle                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tables:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ delivery_requests                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, merchant_id, driver_id, pickup_address,                 â”‚
â”‚ delivery_address, package_description, package_weight,      â”‚
â”‚ recipient_name, recipient_phone, status, final_price        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ delivery_offers                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, delivery_request_id, driver_id, offered_price,          â”‚
â”‚ counter_price, final_price, status, token_spent            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Workflow identique avec:
â€¢ POST /api/delivery-requests (au lieu /api/trips)
â€¢ POST /api/delivery-offers (au lieu /api/trip-offers)
â€¢ Jeton dÃ©pensÃ© lors de l'acceptation finale âœ…
```

---

## Workflow 3: Livraison Restaurant (Restaurant â†’ Driver)

### DiffÃ©rences avec Livraison Marchandise

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPÃ‰CIFICITÃ‰S LIVRAISON RESTAURANT                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. Demande crÃ©Ã©e par Restaurant                             â”‚
â”‚    â€¢ Table: orders (commandes restaurant)                   â”‚
â”‚    â€¢ restaurant_id au lieu de merchant_id                   â”‚
â”‚    â€¢ order_items (plats commandÃ©s)                          â”‚
â”‚                                                             â”‚
â”‚ 2. Champs spÃ©cifiques:                                      â”‚
â”‚    â€¢ order_items: liste des plats                           â”‚
â”‚    â€¢ preparation_time: temps de prÃ©paration                 â”‚
â”‚    â€¢ customer_name, customer_phone                          â”‚
â”‚    â€¢ special_instructions: "Sonnez 2 fois", etc.            â”‚
â”‚    â€¢ delivery_type: "express" ou "normal"                   â”‚
â”‚                                                             â”‚
â”‚ 3. Workflow:                                                â”‚
â”‚    a) Client commande repas sur app                         â”‚
â”‚    b) Restaurant accepte commande                           â”‚
â”‚    c) Restaurant crÃ©e demande livraison                     â”‚
â”‚    d) Drivers voient demande et proposent prix              â”‚
â”‚    e) Restaurant sÃ©lectionne driver                         â”‚
â”‚    f) Acceptation â†’ Jeton dÃ©pensÃ© âœ…                        â”‚
â”‚    g) Driver rÃ©cupÃ¨re commande au restaurant                â”‚
â”‚    h) Driver livre au client                                â”‚
â”‚                                                             â”‚
â”‚ 4. ParticularitÃ©: Timing                                    â”‚
â”‚    â€¢ Driver ne doit pas arriver trop tÃ´t                    â”‚
â”‚    â€¢ ETA driver doit matcher preparation_time               â”‚
â”‚    â€¢ Ex: PrÃ©paration 15min â†’ Driver propose ETA 15-20min    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tables:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orders                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, restaurant_id, customer_id, driver_id,                  â”‚
â”‚ pickup_address (restaurant), delivery_address (client),     â”‚
â”‚ preparation_time, delivery_type, status, final_price        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_items                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, order_id, product_id, quantity, price                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_delivery_offers                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, order_id, driver_id, offered_price,                     â”‚
â”‚ counter_price, final_price, status, token_spent            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ã‰tats et Transitions

### Ã‰tats trip_offers / delivery_offers / order_delivery_offers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DIAGRAMME D'Ã‰TATS: Offres                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                    [Driver envoie proposition]              â”‚
â”‚                              â†“                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚ PENDING  â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                              â”‚                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚              â†“               â†“               â†“             â”‚
â”‚      [Rider sÃ©lectionne] [Autre driver]  [Timeout]         â”‚
â”‚              â†“           sÃ©lectionnÃ©        â†“             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â†“        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚        â”‚ SELECTED â”‚          â”‚        â”‚ NOT_SELECTED â”‚    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â”‚               â”‚                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        token_spent: false   â”‚
â”‚    â†“         â†“         â†“    â”‚                             â”‚
â”‚ [Accept] [Counter] [Reject] â”‚                             â”‚
â”‚    â”‚                    â”‚    â”‚                             â”‚
â”‚    â†“                    â†“    â†“                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚ â”‚ ACCEPTED â”‚      â”‚ REJECTED â”‚                            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚      â”‚                  â”‚                                  â”‚
â”‚ token_spent:     token_spent:                              â”‚
â”‚ TRUE âœ…          FALSE âœ…                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tats finaux:
â€¢ ACCEPTED: Jeton DÃ‰PENSÃ‰ âœ…
â€¢ REJECTED: Jeton INTACT âœ…
â€¢ NOT_SELECTED: Jeton INTACT âœ…
```

### Ã‰tats trips / delivery_requests / orders

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DIAGRAMME D'Ã‰TATS: Courses/Livraisons                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚         [Demandeur crÃ©e demande]                            â”‚
â”‚                  â†“                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚ PENDING  â”‚                                     â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                  â”‚                                          â”‚
â”‚    [Driver sÃ©lectionnÃ© et accepte]                          â”‚
â”‚                  â†“                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚ ACCEPTED â”‚ â† Jeton dÃ©pensÃ© ici âœ…             â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                  â”‚                                          â”‚
â”‚        [Driver dÃ©marre]                                     â”‚
â”‚                  â†“                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚ STARTED  â”‚                                     â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                  â”‚                                          â”‚
â”‚       [Driver complÃ¨te]                                     â”‚
â”‚                  â†“                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚COMPLETED â”‚                                     â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                             â”‚
â”‚ Annulation possible:                                        â”‚
â”‚ PENDING â†’ CANCELLED (pas de jeton dÃ©pensÃ©)                  â”‚
â”‚ ACCEPTED â†’ CANCELLED (jeton dÃ©jÃ  dÃ©pensÃ©, pas de remb.)     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrammes de SÃ©quence

### SÃ©quence 1: Acceptation Directe (SuccÃ¨s)

```
Rider          Backend         Driver          Token System
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 1. POST /tripsâ”‚               â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 2. Notify driversâ”‚               â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 3. POST /offersâ”‚                 â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 4. Verify tokens >= 1            â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚               OK âœ…              â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 5. GET /offersâ”‚               â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 6. PATCH /accept              â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 7. Spend token (trigger)         â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚         -1 jeton âœ…
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 8. Notify                        â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                  â”‚
  â”‚   Success!    â”‚  "AcceptÃ©e!"  â”‚                  â”‚
```

### SÃ©quence 2: NÃ©gociation puis Refus (Jeton Intact)

```
Rider          Backend         Driver          Token System
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 1. Receive offers             â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 2. PATCH /counter-offer       â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 3. Notify                        â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 4. PATCH /reject                 â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚               â”‚ 5. NO token spent âœ…             â”‚
  â”‚               â”‚ (status=rejected)â”‚               â”‚
  â”‚               â”‚               â”‚                  â”‚
  â”‚ 6. Notify "RefusÃ©"            â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                  â”‚
  â”‚               â”‚               â”‚     Jeton: 5â†’5 âœ…â”‚
  â”‚               â”‚               â”‚    (pas dÃ©pensÃ©) â”‚
```

---

## RÃ©sumÃ© des RÃ¨gles ClÃ©s

### 1. VÃ©rification Jeton

```
âœ… Driver DOIT avoir >= 1 jeton pour envoyer proposition
âœ… VÃ©rifiÃ© via RLS policy Supabase
âŒ Pas de vÃ©rification manuelle dans le code
```

### 2. DÃ©pense Jeton

```
âŒ PAS lors de l'envoi de la proposition
âœ… SEULEMENT lors de l'acceptation finale (status = 'accepted')
âœ… Via trigger PostgreSQL automatique
âœ… EnregistrÃ© dans token_transactions
```

### 3. Cas oÃ¹ Jeton N'est PAS DÃ©pensÃ©

```
âœ… Proposition envoyÃ©e mais rider ne sÃ©lectionne pas ce driver
âœ… Rider sÃ©lectionne mais driver refuse contre-offre
âœ… Rider annule la demande avant acceptation
âœ… Timeout sans rÃ©ponse
âœ… Rider choisit un autre driver
```

### 4. Cas oÃ¹ Jeton EST DÃ©pensÃ©

```
âœ… Rider accepte prix initial du driver
âœ… Rider fait contre-offre ET driver accepte
âœ… Driver fait contre-contre-offre ET rider accepte
âœ… Accord final trouvÃ© (peu importe nombre d'aller-retours)
```

### 5. Transparence

```
âœ… Driver voit: "Jeton dÃ©pensÃ© SEULEMENT si accord final"
âœ… Message aprÃ¨s envoi: "Jeton dÃ©pensÃ© si acceptÃ©e"
âœ… Pas de surprise, tout est clair
```

---

**Document gÃ©nÃ©rÃ©**: 2025-11-30
**Version**: 1.0 COMPLETE
**Statut**: âœ… Production Ready

Ce document dÃ©finit les workflows complets avec tous les dÃ©tails techniques nÃ©cessaires pour l'implÃ©mentation. ğŸš€
